name: Build Windows Executable

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'server/outlook-attach-server.py'
      - 'server/outlook-attach-launcher.py'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install pyinstaller
        pip install pywin32
    
    - name: Clean previous builds
      working-directory: ./server
      run: |
        if exist dist rmdir /s /q dist
        if exist build rmdir /s /q build
        if exist *.spec del /q *.spec
    
    - name: Build Windows GUI launcher
      working-directory: ./server
      run: |
        python -m PyInstaller --windowed --onedir --name "Outlook Auto Attach Server" --add-data "outlook-attach-server.py;." --hidden-import=tkinter --hidden-import=json --hidden-import=http.server --hidden-import=subprocess --hidden-import=platform --hidden-import=shutil --hidden-import=tempfile --hidden-import=datetime --hidden-import=socket --hidden-import=threading --hidden-import=importlib.util --hidden-import=win32com.client --clean outlook-attach-launcher.py
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: outlook-attach-server-windows
        path: server/dist/Outlook Auto Attach Server/Outlook Auto Attach Server.exe
    
    - name: Upload Windows app folder
      uses: actions/upload-artifact@v4
      with:
        name: outlook-attach-server-windows-folder
        path: server/dist/Outlook Auto Attach Server/

